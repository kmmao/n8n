# n8n 开发工作流

## 基础开发循环

### 标准工作流程

1. **启动开发模式**
   ```bash
   pnpm dev
   ```

2. **编写代码**
   - 修改源文件
   - 自动重新构建和重载

3. **测试生产模式**
   ```bash
   pnpm build
   pnpm start
   ```

4. **创建测试**
   - 单元测试
   - 工作流测试（针对节点）

5. **运行测试**
   ```bash
   pnpm test
   ```

6. **提交代码并创建 PR**

## 开发场景详解

### 场景 1: 全栈功能开发

#### 步骤概览
1. 定义 API 类型
2. 实现后端逻辑
3. 添加 API 端点
4. 实现前端 UI
5. 编写测试
6. 运行类型检查

#### 详细步骤

**1. 定义 API 类型** (`packages/@n8n/api-types`)

```typescript
// packages/@n8n/api-types/src/myFeature.ts
export interface MyFeatureRequest {
  name: string;
  options: {
    enabled: boolean;
  };
}

export interface MyFeatureResponse {
  id: string;
  status: 'success' | 'error';
  data: unknown;
}
```

**2. 实现后端逻辑** (`packages/cli`)

后端遵循 **Controller-Service-Repository** 模式：

```typescript
// packages/cli/src/services/myFeature.service.ts
import { Service } from '@n8n/di';
import { UnexpectedError } from '@n8n/errors';

@Service()
export class MyFeatureService {
  async processFeature(data: MyFeatureRequest): Promise<MyFeatureResponse> {
    try {
      // 业务逻辑
      return {
        id: '123',
        status: 'success',
        data: {},
      };
    } catch (error) {
      throw new UnexpectedError('Failed to process feature', { cause: error });
    }
  }
}
```

**3. 添加 Controller** (Express REST API)

```typescript
// packages/cli/src/controllers/myFeature.controller.ts
import { Post, RestController } from '@/decorators';
import { MyFeatureRequest, MyFeatureResponse } from '@n8n/api-types';
import { MyFeatureService } from '@/services/myFeature.service';

@RestController('/my-feature')
export class MyFeatureController {
  constructor(private myFeatureService: MyFeatureService) {}

  @Post('/')
  async create(req: MyFeatureRequest): Promise<MyFeatureResponse> {
    return await this.myFeatureService.processFeature(req);
  }
}
```

**4. 实现前端**

a. **添加 i18n 翻译** (`packages/frontend/@n8n/i18n`)

```json
// packages/frontend/@n8n/i18n/locales/en/index.json
{
  "myFeature": {
    "title": "My Feature",
    "description": "This is my new feature"
  }
}
```

b. **更新 Pinia Store** (`packages/frontend/@n8n/stores`)

```typescript
// packages/frontend/@n8n/stores/src/myFeature.store.ts
import { defineStore } from 'pinia';
import { ref } from 'vue';
import type { MyFeatureResponse } from '@n8n/api-types';

export const useMyFeatureStore = defineStore('myFeature', () => {
  const data = ref<MyFeatureResponse | null>(null);

  async function fetchData() {
    // 使用 rest-api-client
    const response = await fetch('/api/my-feature');
    data.value = await response.json();
  }

  return { data, fetchData };
});
```

c. **创建 Vue 组件** (`packages/frontend/editor-ui`)

```vue
<!-- packages/frontend/editor-ui/src/components/MyFeature.vue -->
<template>
  <div :class="$style.container">
    <h2>{{ i18n.baseText('myFeature.title') }}</h2>
    <p>{{ i18n.baseText('myFeature.description') }}</p>
  </div>
</template>

<script setup lang="ts">
import { useI18n } from '@n8n/composables';
import { useMyFeatureStore } from '@n8n/stores';

const i18n = useI18n();
const myFeatureStore = useMyFeatureStore();
</script>

<style module>
.container {
  padding: var(--spacing--md);
  background: var(--color--background);
}
</style>
```

**5. 编写测试**

后端测试 (Jest):
```typescript
// packages/cli/test/unit/services/myFeature.service.test.ts
import { MyFeatureService } from '@/services/myFeature.service';

describe('MyFeatureService', () => {
  let service: MyFeatureService;

  beforeEach(() => {
    service = new MyFeatureService();
  });

  it('should process feature successfully', async () => {
    const result = await service.processFeature({
      name: 'test',
      options: { enabled: true },
    });

    expect(result.status).toBe('success');
  });
});
```

前端测试 (Vitest):
```typescript
// packages/frontend/editor-ui/src/components/__tests__/MyFeature.test.ts
import { describe, it, expect } from 'vitest';
import { mount } from '@vue/test-utils';
import MyFeature from '../MyFeature.vue';

describe('MyFeature', () => {
  it('renders correctly', () => {
    const wrapper = mount(MyFeature);
    expect(wrapper.text()).toContain('My Feature');
  });
});
```

**6. 构建和类型检查**

```bash
# 如果修改了类型/接口，先构建
pnpm build

# 运行类型检查
pnpm typecheck

# 或在特定包中运行
cd packages/cli
pnpm typecheck
```

### 场景 2: 创建自定义节点

#### 1. 使用脚手架创建节点

```bash
pnpm --filter @n8n/node-cli create
```

按提示输入节点信息。

#### 2. 实现节点逻辑

```typescript
// packages/nodes-base/nodes/MyNode/MyNode.node.ts
import type {
  IExecuteFunctions,
  INodeExecutionData,
  INodeType,
  INodeTypeDescription,
} from 'n8n-workflow';

export class MyNode implements INodeType {
  description: INodeTypeDescription = {
    displayName: 'My Node',
    name: 'myNode',
    icon: 'file:myNode.svg',
    group: ['transform'],
    version: 1,
    description: 'My custom node',
    defaults: {
      name: 'My Node',
    },
    inputs: ['main'],
    outputs: ['main'],
    properties: [
      {
        displayName: 'Text',
        name: 'text',
        type: 'string',
        default: '',
      },
    ],
  };

  async execute(this: IExecuteFunctions): Promise<INodeExecutionData[][]> {
    const items = this.getInputData();
    const returnData: INodeExecutionData[] = [];

    for (let i = 0; i < items.length; i++) {
      const text = this.getNodeParameter('text', i) as string;

      returnData.push({
        json: { text },
      });
    }

    return [returnData];
  }
}
```

#### 3. 创建工作流测试

```json
// packages/nodes-base/nodes/MyNode/test/MyNode.workflow.test.json
{
  "name": "My Node Workflow",
  "nodes": [
    {
      "parameters": {
        "text": "Hello World"
      },
      "name": "My Node",
      "type": "n8n-nodes-base.myNode",
      "position": [250, 300]
    }
  ],
  "connections": {}
}
```

#### 4. 启动带热重载的开发

```bash
N8N_DEV_RELOAD=true pnpm dev
```

现在修改节点代码会自动重载！

### 场景 3: 修复 Bug

#### 1. 创建分支

```bash
# 从最新的 master 创建分支
git checkout master
git pull upstream master
git checkout -b fix/bug-description
```

#### 2. 定位问题

使用以下工具：
- VS Code 调试器
- `console.log` / `debugger`
- Chrome DevTools (前端)
- Node.js Inspector (后端)

#### 3. 编写复现测试（重要！）

```typescript
// 先写一个失败的测试来复现 bug
it('should handle edge case', () => {
  // 触发 bug 的代码
  expect(() => buggyFunction()).not.toThrow();
});
```

#### 4. 修复代码

#### 5. 确认测试通过

```bash
pnpm test
```

#### 6. 运行受影响的测试

```bash
pnpm test:affected
```

## 代码质量检查

### 在提交前运行

```bash
# 代码检查
pnpm lint

# 自动修复 lint 问题
pnpm lint:fix

# 类型检查
pnpm typecheck

# 格式化代码
pnpm format
```

### 在特定包中运行

```bash
cd packages/cli
pnpm lint
pnpm typecheck
```

## Git 工作流

### 提交代码

项目使用 **lefthook** 自动运行 git hooks：
- Pre-commit: 代码格式检查
- Pre-push: 可能运行测试

```bash
# 添加修改
git add .

# 提交（遵循 Angular 规范）
git commit -m "fix(core): Fix workflow execution bug"
```

### 创建 Pull Request

1. **推送分支**
   ```bash
   git push origin your-branch-name
   ```

2. **创建 PR**
   ```bash
   # 使用 GitHub CLI
   gh pr create --draft
   ```

3. **PR 标题遵循规范**（见 `.github/pull_request_title_conventions.md`）
   ```
   <type>(<scope>): <summary>
   ```

   类型:
   - `feat`: 新功能
   - `fix`: Bug 修复
   - `docs`: 文档
   - `refactor`: 重构
   - `test`: 测试
   - `perf`: 性能优化

   示例:
   - `feat(editor): Add new node picker`
   - `fix(core): Fix workflow execution error`
   - `docs(api): Update API documentation`

4. **PR 描述包含**
   - 修改摘要
   - Linear ticket 链接: `https://linear.app/n8n/issue/[TICKET-ID]`
   - 截图/视频（如果是 UI 修改）
   - 测试计划

## 包管理技巧

### 添加依赖

```bash
# 在特定包中添加依赖
pnpm --filter @n8n/editor-ui add lodash

# 添加开发依赖
pnpm --filter @n8n/editor-ui add -D @types/lodash

# 在 workspace root 添加
pnpm add -w some-package
```

### 运行特定包的脚本

```bash
# 使用 filter
pnpm --filter @n8n/editor-ui dev

# 或进入目录
cd packages/frontend/editor-ui
pnpm dev
```

## 调试技巧

### 后端调试

在 VS Code 中创建 `.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Debug n8n",
      "runtimeExecutable": "pnpm",
      "runtimeArgs": ["start"],
      "console": "integratedTerminal",
      "skipFiles": ["<node_internals>/**"]
    }
  ]
}
```

### 前端调试

在浏览器中使用 Vue DevTools:
- Chrome: https://chrome.google.com/webstore/detail/vuejs-devtools
- Firefox: https://addons.mozilla.org/en-US/firefox/addon/vue-js-devtools/

## 性能分析

### 构建性能

```bash
# 查看 Turbo 构建缓存
pnpm build --summarize

# 清理缓存重新构建
pnpm clean
pnpm build
```

### 运行时性能

- Chrome DevTools Performance tab
- Vue DevTools Performance
- Node.js --inspect flag

## 下一步

- 📖 阅读 `04-测试指南.md` 了解测试详情
- 📖 阅读 `05-常用命令.md` 快速查找命令
- 📖 阅读 `06-最佳实践.md` 了解代码规范
