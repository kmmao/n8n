# n8n æµ‹è¯•æŒ‡å—

## æµ‹è¯•ç­–ç•¥æ¦‚è§ˆ

n8n ä½¿ç”¨å¤šå±‚æµ‹è¯•ç­–ç•¥ï¼š

| æµ‹è¯•ç±»å‹ | å·¥å…· | ç”¨é€” | ä½ç½® |
|---------|------|------|------|
| å•å…ƒæµ‹è¯•ï¼ˆåç«¯ï¼‰ | Jest | æµ‹è¯•ç‹¬ç«‹å‡½æ•°ã€ç±»ã€æœåŠ¡ | `**/*.test.ts` |
| å•å…ƒæµ‹è¯•ï¼ˆå‰ç«¯ï¼‰ | Vitest | æµ‹è¯• Vue ç»„ä»¶ã€composables | `**/__tests__/**` |
| å·¥ä½œæµæµ‹è¯• | Jest + JSON | æµ‹è¯•èŠ‚ç‚¹æ‰§è¡Œé€»è¾‘ | `nodes/**/test/*.test.json` |
| E2E æµ‹è¯• | Playwright | æµ‹è¯•å®Œæ•´ç”¨æˆ·æµç¨‹ | `cypress/` (è¿ç§»ä¸­) |
| HTTP Mock | nock | Mock å¤–éƒ¨ API è°ƒç”¨ | å•å…ƒæµ‹è¯•ä¸­ |

## è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰åŒ…çš„æ‰€æœ‰æµ‹è¯•
pnpm test

# åªè¿è¡Œå—å½±å“çš„æµ‹è¯•ï¼ˆåŸºäº git diffï¼‰
pnpm test:affected
```

### è¿è¡Œç‰¹å®šåŒ…çš„æµ‹è¯•

```bash
# æ–¹å¼ 1: è¿›å…¥åŒ…ç›®å½•
cd packages/cli
pnpm test

# æ–¹å¼ 2: ä½¿ç”¨ filter
pnpm --filter @n8n/cli test
```

### è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶

```bash
# å¿…é¡»åœ¨åŒ…ç›®å½•å†…è¿è¡Œ
cd packages/cli
pnpm test src/services/myService.test.ts

# æˆ–ä½¿ç”¨ Jest çš„æ¨¡å¼åŒ¹é…
pnpm test --testPathPattern=myService
```

### Watch æ¨¡å¼

```bash
cd packages/cli
pnpm test --watch
```

åœ¨ watch æ¨¡å¼ä¸‹:
- æŒ‰ `p` è¿‡æ»¤æ–‡ä»¶å
- æŒ‰ `t` è¿‡æ»¤æµ‹è¯•å
- æŒ‰ `u` æ›´æ–°å¿«ç…§
- æŒ‰ `q` é€€å‡º

## åç«¯å•å…ƒæµ‹è¯• (Jest)

### åŸºæœ¬ç»“æ„

```typescript
// packages/cli/test/unit/services/workflow.service.test.ts
import { WorkflowService } from '@/services/workflow.service';
import { mock } from 'jest-mock-extended';
import type { WorkflowRepository } from '@/databases/repositories/workflow.repository';

describe('WorkflowService', () => {
  let workflowService: WorkflowService;
  let mockWorkflowRepository: WorkflowRepository;

  beforeEach(() => {
    // åˆ›å»º mock å¯¹è±¡
    mockWorkflowRepository = mock<WorkflowRepository>();

    // åˆ›å»ºè¢«æµ‹è¯•çš„æœåŠ¡
    workflowService = new WorkflowService(mockWorkflowRepository);
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  describe('getWorkflow', () => {
    it('should return workflow when it exists', async () => {
      // Arrange
      const workflowId = '123';
      const expectedWorkflow = { id: workflowId, name: 'Test' };
      mockWorkflowRepository.findById.mockResolvedValue(expectedWorkflow);

      // Act
      const result = await workflowService.getWorkflow(workflowId);

      // Assert
      expect(result).toEqual(expectedWorkflow);
      expect(mockWorkflowRepository.findById).toHaveBeenCalledWith(workflowId);
    });

    it('should throw error when workflow not found', async () => {
      // Arrange
      mockWorkflowRepository.findById.mockResolvedValue(null);

      // Act & Assert
      await expect(workflowService.getWorkflow('999'))
        .rejects
        .toThrow('Workflow not found');
    });
  });
});
```

### Mock HTTP è¯·æ±‚ (nock)

```typescript
import nock from 'nock';

describe('ExternalAPIService', () => {
  beforeEach(() => {
    // ç¦æ­¢çœŸå® HTTP è¯·æ±‚
    nock.disableNetConnect();
  });

  afterEach(() => {
    nock.cleanAll();
    nock.enableNetConnect();
  });

  it('should fetch data from external API', async () => {
    // Mock HTTP å“åº”
    nock('https://api.example.com')
      .get('/data')
      .reply(200, { result: 'success' });

    const service = new ExternalAPIService();
    const result = await service.fetchData();

    expect(result.result).toBe('success');
  });

  it('should handle API errors', async () => {
    nock('https://api.example.com')
      .get('/data')
      .reply(500, { error: 'Internal Server Error' });

    const service = new ExternalAPIService();

    await expect(service.fetchData()).rejects.toThrow();
  });
});
```

### æµ‹è¯•ä¾èµ–æ³¨å…¥

```typescript
import { Container } from '@n8n/di';
import { MyService } from '@/services/my.service';
import { MyRepository } from '@/repositories/my.repository';

describe('MyService with DI', () => {
  let container: Container;
  let service: MyService;

  beforeEach(() => {
    container = new Container();
    container.bind(MyRepository).toConstantValue(mock<MyRepository>());
    service = container.get(MyService);
  });

  it('should work with injected dependencies', () => {
    // æµ‹è¯•ä»£ç 
  });
});
```

## å‰ç«¯å•å…ƒæµ‹è¯• (Vitest)

### æµ‹è¯• Vue ç»„ä»¶

```typescript
// packages/frontend/editor-ui/src/components/__tests__/MyButton.test.ts
import { describe, it, expect, vi } from 'vitest';
import { mount } from '@vue/test-utils';
import MyButton from '../MyButton.vue';

describe('MyButton', () => {
  it('renders correctly', () => {
    const wrapper = mount(MyButton, {
      props: {
        label: 'Click me',
      },
    });

    expect(wrapper.text()).toContain('Click me');
  });

  it('emits click event when clicked', async () => {
    const wrapper = mount(MyButton);

    await wrapper.find('button').trigger('click');

    expect(wrapper.emitted('click')).toHaveLength(1);
  });

  it('disables button when disabled prop is true', () => {
    const wrapper = mount(MyButton, {
      props: {
        disabled: true,
      },
    });

    const button = wrapper.find('button');
    expect(button.attributes('disabled')).toBeDefined();
  });
});
```

### æµ‹è¯• Pinia Store

```typescript
// packages/frontend/@n8n/stores/__tests__/ui.store.test.ts
import { setActivePinia, createPinia } from 'pinia';
import { describe, it, expect, beforeEach } from 'vitest';
import { useUIStore } from '../ui.store';

describe('useUIStore', () => {
  beforeEach(() => {
    setActivePinia(createPinia());
  });

  it('should toggle sidebar', () => {
    const store = useUIStore();

    expect(store.sidebarOpen).toBe(false);

    store.toggleSidebar();
    expect(store.sidebarOpen).toBe(true);

    store.toggleSidebar();
    expect(store.sidebarOpen).toBe(false);
  });

  it('should add notification', () => {
    const store = useUIStore();

    store.addNotification({
      type: 'success',
      message: 'Test message',
    });

    expect(store.notifications).toHaveLength(1);
    expect(store.notifications[0].message).toBe('Test message');
  });
});
```

### æµ‹è¯• Composables

```typescript
// packages/frontend/@n8n/composables/__tests__/useMyComposable.test.ts
import { describe, it, expect } from 'vitest';
import { ref } from 'vue';
import { useMyComposable } from '../useMyComposable';

describe('useMyComposable', () => {
  it('should compute correctly', () => {
    const input = ref(5);
    const { doubled } = useMyComposable(input);

    expect(doubled.value).toBe(10);

    input.value = 10;
    expect(doubled.value).toBe(20);
  });
});
```

### Mock API è°ƒç”¨

```typescript
import { vi } from 'vitest';

// Mock æ•´ä¸ªæ¨¡å—
vi.mock('@n8n/rest-api-client', () => ({
  useRestApi: () => ({
    getWorkflows: vi.fn().mockResolvedValue([
      { id: '1', name: 'Workflow 1' },
    ]),
  }),
}));
```

## èŠ‚ç‚¹å·¥ä½œæµæµ‹è¯•

### JSON å·¥ä½œæµæµ‹è¯•

```json
// packages/nodes-base/nodes/MyNode/test/MyNode.workflow.test.json
{
  "name": "Test MyNode with basic input",
  "nodes": [
    {
      "parameters": {
        "text": "Hello World"
      },
      "name": "My Node",
      "type": "n8n-nodes-base.myNode",
      "typeVersion": 1,
      "position": [250, 300],
      "id": "node-1"
    }
  ],
  "connections": {},
  "pinData": {
    "My Node": [
      {
        "json": {
          "text": "Hello World"
        }
      }
    ]
  }
}
```

### èŠ‚ç‚¹æ‰§è¡Œæµ‹è¯•

```typescript
// packages/nodes-base/nodes/MyNode/test/MyNode.node.test.ts
import { testWorkflows } from '@test/nodes/Helpers';

describe('MyNode', () => {
  testWorkflows(['MyNode.workflow.test.json']);
});
```

è¿™ä¼šè‡ªåŠ¨ï¼š
1. åŠ è½½ JSON å·¥ä½œæµ
2. æ‰§è¡ŒèŠ‚ç‚¹
3. éªŒè¯è¾“å‡ºä¸ pinData åŒ¹é…

## E2E æµ‹è¯• (Playwright)

### è¿è¡Œ E2E æµ‹è¯•

```bash
# å¼€å‘æ¨¡å¼ï¼ˆäº¤äº’å¼ï¼‰
pnpm dev:e2e

# è¿è¡Œæ‰€æœ‰ E2E æµ‹è¯•
pnpm test:with:docker

# æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š
pnpm test:show:report
```

### ç¼–å†™ E2E æµ‹è¯•

```typescript
// packages/n8n-playwright/tests/workflow.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Workflow Editor', () => {
  test('should create new workflow', async ({ page }) => {
    // è®¿é—® n8n
    await page.goto('http://localhost:5678');

    // ç‚¹å‡»æ–°å»ºå·¥ä½œæµ
    await page.click('text=New workflow');

    // éªŒè¯å·¥ä½œæµç”»å¸ƒæ˜¾ç¤º
    await expect(page.locator('.workflow-canvas')).toBeVisible();
  });

  test('should add node to workflow', async ({ page }) => {
    await page.goto('http://localhost:5678');

    // æ‰“å¼€èŠ‚ç‚¹é¢æ¿
    await page.click('[data-test-id="node-creator"]');

    // æœç´¢èŠ‚ç‚¹
    await page.fill('[data-test-id="node-search"]', 'HTTP Request');

    // æ·»åŠ èŠ‚ç‚¹
    await page.click('text=HTTP Request');

    // éªŒè¯èŠ‚ç‚¹å·²æ·»åŠ 
    await expect(page.locator('.node-item')).toContainText('HTTP Request');
  });
});
```

## æµ‹è¯•è¦†ç›–ç‡

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
COVERAGE_ENABLED=true pnpm test

# æŸ¥çœ‹è¦†ç›–ç‡
open coverage/index.html
```

### åœ¨ VS Code ä¸­æŸ¥çœ‹è¦†ç›–ç‡

1. å®‰è£…æ‰©å±•: **Coverage Gutters**
2. è¿è¡Œæµ‹è¯•ç”Ÿæˆè¦†ç›–ç‡
3. åœ¨ VS Code ä¸­æŒ‰ `Cmd+Shift+P` â†’ "Coverage Gutters: Display Coverage"

ç»¿è‰²: å·²è¦†ç›–
çº¢è‰²: æœªè¦†ç›–

## æµ‹è¯•æœ€ä½³å®è·µ

### âœ… DO

1. **éµå¾ª AAA æ¨¡å¼**
   ```typescript
   it('should do something', () => {
     // Arrange - å‡†å¤‡
     const input = 'test';

     // Act - æ‰§è¡Œ
     const result = myFunction(input);

     // Assert - æ–­è¨€
     expect(result).toBe('expected');
   });
   ```

2. **Mock æ‰€æœ‰å¤–éƒ¨ä¾èµ–**
   - æ•°æ®åº“
   - HTTP è¯·æ±‚
   - æ–‡ä»¶ç³»ç»Ÿ
   - æ—¶é—´/æ—¥æœŸ

3. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ**
   - ç©ºå€¼ (null, undefined)
   - ç©ºæ•°ç»„/å¯¹è±¡
   - æå¤§/æå°å€¼
   - é”™è¯¯æƒ…å†µ

4. **ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°**
   ```typescript
   // âŒ Bad
   it('works', () => {});

   // âœ… Good
   it('should return user when valid ID is provided', () => {});
   ```

5. **ä¸€ä¸ªæµ‹è¯•åªæµ‹ä¸€ä»¶äº‹**
   ```typescript
   // âŒ Bad
   it('should do everything', () => {
     expect(a).toBe(1);
     expect(b).toBe(2);
     expect(c).toBe(3);
   });

   // âœ… Good
   it('should set a to 1', () => {
     expect(a).toBe(1);
   });

   it('should set b to 2', () => {
     expect(b).toBe(2);
   });
   ```

### âŒ DON'T

1. **ä¸è¦æµ‹è¯•å®ç°ç»†èŠ‚**
   - æµ‹è¯•è¡Œä¸ºï¼Œä¸æ˜¯å®ç°
   - æµ‹è¯•å…¬å…± APIï¼Œä¸æ˜¯ç§æœ‰æ–¹æ³•

2. **ä¸è¦åœ¨æµ‹è¯•ä¸­ä½¿ç”¨çœŸå®æ•°æ®åº“**
   - ä½¿ç”¨ mock æˆ–å†…å­˜æ•°æ®åº“

3. **ä¸è¦åœ¨æµ‹è¯•é—´å…±äº«çŠ¶æ€**
   - æ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹
   - ä½¿ç”¨ beforeEach é‡ç½®çŠ¶æ€

4. **ä¸è¦è·³è¿‡å¤±è´¥çš„æµ‹è¯•**
   ```typescript
   // âŒ Bad
   it.skip('broken test', () => {});

   // âœ… Good - ä¿®å¤å®ƒï¼
   it('fixed test', () => {});
   ```

## è°ƒè¯•æµ‹è¯•

### Jest/Vitest è°ƒè¯•

åœ¨ VS Code ä¸­åˆ›å»ºè°ƒè¯•é…ç½®:

```json
{
  "type": "node",
  "request": "launch",
  "name": "Debug Jest",
  "program": "${workspaceFolder}/node_modules/.bin/jest",
  "args": [
    "--runInBand",
    "--testPathPattern=${fileBasename}"
  ],
  "console": "integratedTerminal",
  "internalConsoleOptions": "neverOpen"
}
```

### Playwright è°ƒè¯•

```bash
# åœ¨ UI æ¨¡å¼ä¸‹è¿è¡Œ
pnpm --filter n8n-playwright exec playwright test --ui

# ä½¿ç”¨è°ƒè¯•æ¨¡å¼
pnpm --filter n8n-playwright exec playwright test --debug
```

## å¿«ç…§æµ‹è¯•

### æ›´æ–°å¿«ç…§

```bash
# æ›´æ–°æ‰€æœ‰å¿«ç…§
pnpm test -u

# åœ¨ watch æ¨¡å¼ä¸‹æŒ‰ 'u' æ›´æ–°
pnpm test --watch
# ç„¶åæŒ‰ 'u'
```

### å¿«ç…§ç¤ºä¾‹

```typescript
it('should render component correctly', () => {
  const wrapper = mount(MyComponent);
  expect(wrapper.html()).toMatchSnapshot();
});
```

## CI ä¸­çš„æµ‹è¯•

é¡¹ç›®åœ¨ GitHub Actions ä¸­è¿è¡Œæµ‹è¯•:

```bash
# è¿è¡Œ CI æµ‹è¯•ï¼ˆç»§ç»­å¤±è´¥ï¼‰
pnpm test:ci

# åªè¿è¡Œå‰ç«¯æµ‹è¯•
pnpm test:ci:frontend

# åªè¿è¡Œåç«¯æµ‹è¯•
pnpm test:ci:backend
```

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•åªè¿è¡Œä¸€ä¸ªæµ‹è¯•ï¼Ÿ

```typescript
// ä½¿ç”¨ .only
it.only('this test will run', () => {});
```

### Q: å¦‚ä½•è·³è¿‡æµ‹è¯•ï¼Ÿ

```typescript
// ä½¿ç”¨ .skip
it.skip('this test will be skipped', () => {});
```

### Q: æµ‹è¯•è¿è¡Œå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

1. åªè¿è¡Œå—å½±å“çš„æµ‹è¯•: `pnpm test:affected`
2. ä½¿ç”¨ watch æ¨¡å¼
3. å¹¶è¡Œè¿è¡Œ: `pnpm test --maxWorkers=4`

### Q: Mock ä¸èµ·ä½œç”¨ï¼Ÿ

ç¡®ä¿ mock åœ¨ import ä¹‹å‰:

```typescript
// âœ… Correct
vi.mock('./module');
import { something } from './module';

// âŒ Wrong
import { something } from './module';
vi.mock('./module');
```

## ä¸‹ä¸€æ­¥

- ğŸ“– æŸ¥çœ‹å®é™…æµ‹è¯•ç¤ºä¾‹: `packages/nodes-base/nodes/**/__tests__`
- ğŸ“– é˜…è¯» `05-å¸¸ç”¨å‘½ä»¤.md` å¿«é€ŸæŸ¥æ‰¾æµ‹è¯•å‘½ä»¤
- ğŸ“– å‚è€ƒå®˜æ–¹æ–‡æ¡£: [Jest](https://jestjs.io/) | [Vitest](https://vitest.dev/) | [Playwright](https://playwright.dev/)
